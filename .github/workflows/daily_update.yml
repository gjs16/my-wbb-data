name: Daily Data Refresh and Sheets Sync

on:
  schedule:
    - cron: '0 9 * * *' # Runs daily at 9:00 AM UTC
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      # This is critical for the auto-commit action to be able to push changes
      contents: write
    # The 'secrets: inherit' line was removed here as it is not valid for a standalone job.
    # Secrets are accessed directly in the steps below.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. AUTHENTICATION: Writes the JSON key (from the secret) to a file the R script can read
      - name: Setup Google Sheets Auth
        env:
          GCS_AUTH_JSON: ${{ secrets.GCS_AUTH_JSON }}
        run: |
          echo "$GCS_AUTH_JSON" > gcs_auth.json

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      # 2. INSTALL: Install googlesheets4 and googledrive packages
      - name: Install R packages
        run: |
          Rscript -e 'install.packages("remotes")'
          Rscript -e 'remotes::install_cran(c("tidyverse", "wehoop", "janitor", "googlesheets4", "googledrive"))'
      
      # 3. RUN: Executes the R script and passes the Sheet ID as an environment variable
      - name: Run update script and Sheets Sync
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        run: Rscript update_data.R

      # 4. COMMIT: Commits the updated uncompressed files back to the GitHub repo
      - name: Commit and Push changes (to GitHub)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated WBB Data Refresh: Box Scores, Schedules, and LLM Context"
          file_pattern: data/*
          branch: ${{ github.ref_name }}
          pull_strategy: rebase
          # FIX: This explicitly passes the token, required for scheduled pushes.
          token: ${{ secrets.GITHUB_TOKEN }}
