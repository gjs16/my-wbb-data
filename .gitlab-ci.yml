# .gitlab-ci.yml
# This file defines the GitLab CI/CD job for data refresh and sync.

# Use a Docker image with R pre-installed for the runner environment.
# 'rocker/r-ver:latest' is a standard, robust choice.
image: rocker/r-ver:latest

# Define the single stage for this pipeline
stages:
  - refresh_and_sync

update-data:
  stage: refresh_and_sync
  
  # --- 1. SETUP & AUTHENTICATION (Before the main script) ---
  before_script:
    # 1. Install System Dependencies (from your original step)
    - apt-get update
    - apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

    # 2. Install R packages (from your original step)
    - Rscript -e 'install.packages("remotes")'
    - Rscript -e 'remotes::install_cran(c("tidyverse", "wehoop", "janitor", "googlesheets4", "googledrive"))'

    # 3. AUTHENTICATION: Writes the JSON key (from the GitLab variable) to a file
    # The variable $GCS_AUTH_JSON must be set in the GitLab CI/CD settings.
    - echo "$GCS_AUTH_JSON" > gcs_auth.json 

  # --- 2. EXECUTION & COMMIT (The main script) ---
  script:
    # 4. RUN: Executes the R script. It automatically uses the $GOOGLE_SHEET_ID variable 
    # and the gcs_auth.json file created above.
    - echo "Starting R data refresh and Sheets sync..."
    - Rscript update_data.R

    # 5. COMMIT: Replace 'stefanzweifel/git-auto-commit-action' with raw git commands
    - echo "Checking for changes to commit..."
    
    # Configure git user details
    - git config user.email "gitlab-ci-bot@example.com"
    - git config user.name "GitLab CI Bot"
    
    # Stage and commit the files in the data/ directory
    - git add data/*
    
    # Check if there are any changes (git status --porcelain) before attempting to commit
    - |
      if [ -n "$(git status --porcelain)" ]; then
        echo "Changes detected. Committing and pushing..."
        git commit -m "Automated WBB Data Refresh: Box Scores, Schedules, and LLM Context"
        
        # Push the changes using the $CI_JOB_TOKEN for write access.
        # HEAD:$CI_COMMIT_BRANCH pushes the local commit to the current branch.
        git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:$CI_COMMIT_BRANCH
      else
        echo "No changes detected, skipping commit/push."
      fi

  # --- 3. TRIGGER RULES ---
  # Define when this job should run: either on a schedule or manually (web/api)
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "api"
